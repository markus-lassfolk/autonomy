# RUTOS Test Environment Dockerfile
# Based on official OpenWrt Docker: https://github.com/openwrt/docker
# Uses the official OpenWrt SDK container for building packages
FROM openwrt/sdk:arm_cortex-a7_neon-vfpv4

# Set environment variables
ENV GCC_COLORS='error=01;31:warning=01;35:note=01;36:caret=01;32:locus=01:quote=01'
WORKDIR /workdir

# Install Go (matching your go.mod version) - ARM version
RUN wget -O go.tar.gz https://go.dev/dl/go1.23.0.linux-armv6l.tar.gz \
    && tar -C /usr/local -xzf go.tar.gz \
    && rm go.tar.gz

# Set Go environment
ENV PATH=$PATH:/usr/local/go/bin
ENV GOPATH=/go
ENV GOCACHE=/go/cache
ENV CGO_ENABLED=0

# Create Go workspace with proper permissions
RUN mkdir -p /go/src /go/bin /go/cache && chmod 755 /go

# Install additional tools for testing
RUN opkg update && opkg install \
    curl \
    git \
    make \
    gcc \
    || echo "Some packages may not be available in this OpenWrt version"

# Copy source code
COPY . /workdir/

# Set proper permissions
RUN chmod -R 755 /workdir

# Default command
CMD ["/bin/sh"]
