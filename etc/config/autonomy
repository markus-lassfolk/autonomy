# Autonomy Configuration - Comprehensive UCI Format with Documentation
# Copy this file to /etc/config/Autonomy and modify as needed
#
# üéØ PURPOSE: Complete failover configuration with all features enabled
# üè† BEST FOR: Advanced users, mobile deployments, production environments
#
# üöÄ KEY FEATURES:
# ‚Ä¢ Automatic failover between Starlink, cellular, WiFi, and LAN
# ‚Ä¢ Smart thresholds with predictive failover using machine learning
# ‚Ä¢ Full Starlink API integration with diagnostics and health monitoring
# ‚Ä¢ Pushover notifications for network events and status changes
# ‚Ä¢ GPS-aware WiFi optimization with movement detection
# ‚Ä¢ OpenCellID cellular geolocation integration
# ‚Ä¢ Advanced metered mode signaling
# ‚Ä¢ Comprehensive monitoring and performance metrics
#
# üí° WHEN TO USE:
# ‚úÖ You want all features enabled with optimal defaults
# ‚úÖ You're mobile (RV, boat, digital nomad) and need WiFi optimization
# ‚úÖ You want detailed notifications and monitoring
# ‚úÖ You need cellular geolocation features
# ‚úÖ You're in production and need comprehensive failover

# =============================================================================
# CORE SYSTEM CONFIGURATION
# =============================================================================
config Autonomy 'main'
    # Basic daemon control
    option enable '1'                    # Master enable/disable switch
    option use_mwan3 '1'                 # Use mwan3 for load balancing (1=yes, 0=no)
    option log_level 'info'              # debug|info|warn|error
    option log_file ''                   # Path to log file (empty = syslog)

    # Timing and intervals
    option poll_interval_ms '1500'       # Health/metrics polling cadence in milliseconds
    option history_window_s '600'        # Data retention window in seconds
    option min_uptime_s '20'             # Minimum uptime before considering member stable
    option cooldown_s '20'               # Cooldown period after member state change

    # Memory and storage
    option retention_hours '24'          # Data retention period in hours
    option max_ram_mb '16'               # Maximum RAM usage in MB

    # Decision making
    option predictive '1'                # Enable predictive failover using machine learning
    option switch_margin '10'            # Margin for switching decisions (percentage)
    option data_cap_mode 'balanced'      # balanced|aggressive|conservative

    # Service endpoints
    option metrics_listener '0'          # Enable metrics HTTP listener (0=disabled)
    option health_listener '1'           # Enable health check HTTP listener

    # Performance and Security (system-wide settings)
    option performance_profiling '0'     # Enable performance profiling
    option security_auditing '1'         # Enable security auditing
    option profiling_enabled '0'         # Enable detailed profiling
    option auditing_enabled '1'          # Enable detailed auditing
    option max_failed_attempts '5'       # Maximum failed attempts before blocking
    option block_duration '300'          # Block duration in seconds

# =============================================================================
# NETWORK THRESHOLDS
# =============================================================================
config thresholds 'failover'
    # When to trigger failover
    option loss '5'                      # Packet loss percentage to trigger failover
    option latency '1200'                # Latency threshold in milliseconds
    option min_duration_s '10'           # Minimum duration before failover

config thresholds 'restore'
    # When to restore/failback
    option loss '1'                      # Packet loss percentage to trigger restore
    option latency '800'                 # Latency threshold in milliseconds
    option min_duration_s '30'           # Minimum duration before restore

config thresholds 'weights'
    # Hybrid weight system for intelligent failover
    option respect_user_weights '1'      # Respect user-defined weights
    option dynamic_adjustment '1'        # Enable dynamic weight adjustment
    option emergency_override '1'        # Allow emergency weight overrides
    option only_emergency_override '0'   # Only use emergency overrides
    option restore_timeout_s '300'       # Timeout for weight restoration
    option minimal_adjustment_points '5' # Minimum points for adjustment
    option temporary_boost_points '20'   # Points for temporary boosts
    option temporary_adjustment_duration_s '600' # Duration of temporary adjustments
    option emergency_adjustment_duration_s '1800' # Duration of emergency adjustments

config thresholds 'intelligence'
    # Intelligent adjustment thresholds
    option starlink_obstruction_threshold '10.0'  # Starlink obstruction threshold (%)
    option cellular_signal_threshold '-85.0'      # RSRP threshold in dBm
    option latency_degradation_threshold '2.0'    # Latency degradation multiplier
    option loss_threshold '5.0'                   # Packet loss threshold (%)

# =============================================================================
# STARLINK API CONFIGURATION
# =============================================================================
config starlink 'api'
    option host '192.168.100.1'          # Starlink dish IP address
    option port '9200'                   # API port (1024-65535)
    option timeout_s '10'                # API timeout in seconds
    option grpc_first '1'                # Try gRPC before HTTP (1=yes, 0=no)
    option http_first '0'                # Try HTTP before gRPC (1=yes, 0=no)

# =============================================================================
# MACHINE LEARNING
# =============================================================================
config ml 'settings'
    option enabled '1'                   # Enable machine learning features
    option model_path '/etc/Autonomy/models.json' # Path to ML models
    option training '1'                  # Enable model training
    option prediction '1'                # Enable predictive failover

# =============================================================================
# MONITORING ENDPOINTS
# =============================================================================
config monitoring 'mqtt'
    option broker ''                     # MQTT broker URL (empty = disabled)
    option topic 'Autonomy/status'       # MQTT topic for status updates

# =============================================================================
# NOTIFICATIONS - CONSOLIDATED (Single section to avoid conflicts)
# =============================================================================
config notifications 'settings'
    # Pushover service credentials
    option pushover_enabled '0'          # Enable Pushover notifications
    option pushover_token ''             # Pushover application token
    option pushover_user ''              # Pushover user key
    option pushover_device ''            # Pushover device name (empty = all devices)
    
    # Notification behavior
    option threshold 'warning'           # info|warning|error|critical
    option acknowledgment_tracking '1'   # Track notification acknowledgments
    option location_enabled '1'          # Include location in notifications
    option rich_context_enabled '1'      # Include rich context in notifications
    option cooldown_s '300'              # Cooldown between notifications
    option max_per_hour '20'             # Maximum notifications per hour
    
    # Which events to notify about
    option event_failover '1'            # Notify on failover events
    option event_failback '1'            # Notify on failback events
    option event_member_down '1'         # Notify when members go down
    option event_member_up '0'           # Notify when members come up
    option event_predictive '1'          # Notify on predictive events
    option event_critical '1'            # Notify on critical events
    option event_recovery '1'            # Notify on recovery events
    
    # Pushover priority levels (-2 to 2)
    option priority_failover '1'         # Priority for failover events
    option priority_failback '0'         # Priority for failback events
    option priority_member_down '1'      # Priority for member down events
    option priority_member_up '-1'       # Priority for member up events
    option priority_predictive '0'       # Priority for predictive events
    option priority_critical '2'         # Priority for critical events
    option priority_recovery '0'         # Priority for recovery events

# =============================================================================
# METERED MODE INTEGRATION
# =============================================================================
config metered 'settings'
    # Metered connection management
    option enabled '0'                   # Enable metered mode signaling
    option warning_threshold '80'        # Warning threshold percentage
    option critical_threshold '95'       # Critical threshold percentage
    option hysteresis_margin '5'         # Hysteresis margin to prevent flapping
    option stability_delay '300'         # Stability delay in seconds
    option reconnect_method 'gentle'     # gentle|aggressive|none
    option debug '0'                     # Enable debug logging

# =============================================================================
# GPS CONFIGURATION
# =============================================================================
config gps 'settings'
    option enabled '1'                   # Enable GPS features
    option source_priority 'rutos,starlink,cellular' # Comma-separated GPS sources
    option movement_threshold_m '500'    # Movement threshold in meters
    option accuracy_threshold_m '50'     # GPS accuracy threshold in meters
    option staleness_threshold_s '300'   # GPS data staleness threshold
    option collection_interval_s '60'    # GPS collection interval
    option movement_detection '1'        # Enable movement detection
    option location_clustering '1'       # Enable location clustering
    option retry_attempts '3'            # Number of retry attempts
    option retry_delay_s '5'             # Delay between retries
    option google_api_enabled '0'        # Enable Google API integration
    option google_api_key ''             # Google API key
    option google_elevation_api_enabled '0' # Enable Google elevation API
    
    # GPS API Server Configuration
    option api_server_enabled '0'        # Enable GPS API server
    option api_server_port '8081'        # Port for GPS API server
    option api_server_host 'localhost'   # Host binding (localhost for security)
    option api_server_auth_key ''        # Optional authentication key

# =============================================================================
# WIFI OPTIMIZATION
# =============================================================================
config wifi 'optimization'
    # Core WiFi optimization settings
    option enabled '0'                   # Enable WiFi optimization
    option movement_threshold '100.0'    # GPS movement threshold (meters)
    option stationary_time '300'         # Time to be stationary before optimization
    option min_improvement '3'           # Minimum dBm improvement required
    option dwell_time '30'               # Time to test each channel (seconds)
    option noise_default '-95'           # Default noise floor (dBm)
    option vht80_threshold '25'          # Minimum signal for 80MHz channels (dBm)
    option vht40_threshold '20'          # Minimum signal for 40MHz channels (dBm)
    option use_dfs '0'                   # Use DFS channels (radar detection)
    option cooldown '3600'               # Cooldown between optimizations (seconds)
    option gps_accuracy_threshold '50.0' # GPS accuracy threshold (meters)
    option location_logging '1'          # Log GPS coordinates
    option timezone 'UTC'                # Timezone for scheduling

config wifi 'scheduler'
    # Scheduled optimization settings
    option nightly_enabled '1'           # Enable nightly optimization
    option nightly_time '02:00'          # Time for nightly optimization
    option nightly_window '60'           # Window for nightly optimization (minutes)
    option weekly_enabled '1'            # Enable weekly deep optimization
    option weekly_days 'sunday'          # Days for weekly optimization
    option weekly_time '03:00'           # Time for weekly optimization
    option weekly_window '120'           # Window for weekly optimization (minutes)
    option check_interval '300'          # Scheduler check interval (seconds)
    option skip_if_recent '1'            # Skip if recent optimization
    option recent_threshold '1800'       # Recent optimization threshold (seconds)

# =============================================================================
# MEMBER CONFIGURATIONS
# =============================================================================

# Starlink member configuration
config member 'starlink_any'
    option detect 'auto'                 # auto|disable|force
    option class 'starlink'              # Member class
    option weight '100'                  # Weight for scoring (0-100)
    option min_uptime_s '30'             # Minimum uptime for this member (seconds)
    option cooldown_s '20'               # Cooldown period for this member (seconds)

# Cellular member configuration
config member 'cellular_any'
    option detect 'auto'                 # auto|disable|force
    option class 'cellular'              # Member class
    option weight '80'                   # Weight for scoring (0-100)
    option prefer_roaming '0'            # Prefer roaming connections (0=penalize roaming)
    option metered '1'                   # Mark as metered connection (reduces probing)
    option min_uptime_s '20'             # Minimum uptime for this member (seconds)
    option cooldown_s '20'               # Cooldown period for this member (seconds)

# WiFi member configuration
config member 'wifi_any'
    option detect 'auto'                 # auto|disable|force
    option class 'wifi'                  # Member class
    option weight '60'                   # Weight for scoring (0-100)
    option min_uptime_s '15'             # Minimum uptime for this member (seconds)
    option cooldown_s '15'               # Cooldown period for this member (seconds)

# LAN member configuration
config member 'lan_any'
    option detect 'auto'                 # auto|disable|force
    option class 'lan'                   # Member class
    option weight '40'                   # Weight for scoring (0-100)
    option min_uptime_s '10'             # Minimum uptime for this member (seconds)
    option cooldown_s '10'               # Cooldown period for this member (seconds)

# Example: Multiple cellular SIMs
config member 'sim1'
    option detect 'auto'                 # auto|disable|force
    option class 'cellular'              # Member class
    option weight '75'                   # Weight for scoring (0-100)
    option prefer_roaming '0'            # Prefer roaming connections (0=penalize roaming)
    option metered '1'                   # Mark as metered connection (reduces probing)
    option min_uptime_s '20'             # Minimum uptime for this member (seconds)
    option cooldown_s '20'               # Cooldown period for this member (seconds)

config member 'sim2'
    option detect 'auto'                 # auto|disable|force
    option class 'cellular'              # Member class
    option weight '70'                   # Weight for scoring (0-100)
    option prefer_roaming '0'            # Prefer roaming connections (0=penalize roaming)
    option metered '1'                   # Mark as metered connection (reduces probing)
    option min_uptime_s '20'             # Minimum uptime for this member (seconds)
    option cooldown_s '20'               # Cooldown period for this member (seconds)

# Example: WiFi tethering
config member 'wifi_tether'
    option detect 'auto'                 # auto|disable|force
    option class 'wifi'                  # Member class
    option weight '50'                   # Weight for scoring (0-100)
    option min_uptime_s '15'             # Minimum uptime for this member (seconds)
    option cooldown_s '15'               # Cooldown period for this member (seconds)

# Example: LAN uplink
config member 'lan_uplink'
    option detect 'auto'                 # auto|disable|force
    option class 'lan'                   # Member class
    option weight '30'                   # Weight for scoring (0-100)
    option min_uptime_s '10'             # Minimum uptime for this member (seconds)
    option cooldown_s '10'               # Cooldown period for this member (seconds)
