name: Documentation Generation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'pkg/**'
      - 'cmd/**'
      - 'docs/**'
      - 'README.md'
      - 'CHANGELOG.md'
  pull_request:
    branches: [ main ]
    paths:
      - 'pkg/**'
      - 'cmd/**'
      - 'docs/**'
      - 'README.md'
      - 'CHANGELOG.md'
  workflow_dispatch:
    inputs:
      doc_type:
        description: 'Type of documentation to generate'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - api
        - changelog
        - readme

permissions:
  contents: write
  pull-requests: read

jobs:
  generate-documentation:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Set environment variables
      env:
        DOC_TYPE_INPUT: ${{ github.event.inputs.doc_type || 'all' }}
        EVENT_NAME_INPUT: ${{ github.event_name }}
      run: |
        echo "DOC_TYPE=$DOC_TYPE_INPUT" >> $GITHUB_ENV
        echo "EVENT_NAME=$EVENT_NAME_INPUT" >> $GITHUB_ENV

    - name: Generate API documentation
      if: env.DOC_TYPE == 'all' || env.DOC_TYPE == 'api'
      run: |
        echo "üìö Generating API documentation..."
        
        # Create docs directory if it doesn't exist
        mkdir -p docs/api
        
        # Generate API documentation using godoc or similar
        # This is a placeholder - replace with actual documentation generation
        echo "# API Documentation" > docs/api/README.md
        echo "" >> docs/api/README.md
        echo "Generated on $(date -u +"%Y-%m-%d %H:%M UTC")" >> docs/api/README.md
        echo "" >> docs/api/README.md
        
        # Generate package documentation
        for pkg in pkg/*/; do
          if [ -d "$pkg" ]; then
            pkg_name=$(basename "$pkg")
            echo "## $pkg_name" >> docs/api/README.md
            echo "" >> docs/api/README.md
            echo "Package documentation for $pkg_name" >> docs/api/README.md
            echo "" >> docs/api/README.md
          fi
        done
        
        echo "‚úÖ API documentation generated"

    - name: Generate changelog
      if: env.DOC_TYPE == 'all' || env.DOC_TYPE == 'changelog'
      run: |
        echo "üìù Generating changelog..."
        
        # Get recent commits for changelog
        git log --oneline --since="1 month ago" > recent-commits.txt
        
        # Create or update CHANGELOG.md
        cat > CHANGELOG.md << 'EOF'
        # Changelog
        
        All notable changes to this project will be documented in this file.
        
        ## [Unreleased]
        
        ### Added
        - New features and improvements
        
        ### Changed
        - Changes in existing functionality
        
        ### Deprecated
        - Soon-to-be removed features
        
        ### Removed
        - Removed features
        
        ### Fixed
        - Bug fixes
        
        ### Security
        - Security vulnerability fixes
        
        ## Recent Commits
        
        EOF
        
        # Add recent commits to changelog
        cat recent-commits.txt >> CHANGELOG.md
        
        echo "‚úÖ Changelog generated"

    - name: Update README
      if: env.DOC_TYPE == 'all' || env.DOC_TYPE == 'readme'
      run: |
        echo "üìñ Updating README..."
        
        # Update build status badges
        sed -i 's|actions/workflows/ci.yml/badge.svg|actions/workflows/ci.yml/badge.svg|g' README.md
        
        # Update version information
        VERSION=$(git describe --tags --always)
        sed -i "s|Version: .*|Version: $VERSION|g" README.md
        
        # Update last updated date
        DATE=$(date -u +"%Y-%m-%d")
        sed -i "s|Last Updated: .*|Last Updated: $DATE|g" README.md
        
        echo "‚úÖ README updated"

    - name: Validate documentation
      run: |
        echo "üîç Validating documentation..."
        
        # Check for broken links in markdown files
        find docs/ -name "*.md" -exec grep -l "http" {} \; | while read file; do
          echo "Checking links in $file"
          # This would use a markdown link checker
          # markdown-link-check "$file" || true
        done
        
        # Check for missing documentation
        for pkg in pkg/*/; do
          if [ -d "$pkg" ]; then
            pkg_name=$(basename "$pkg")
            if [ ! -f "docs/api/$pkg_name.md" ]; then
              echo "‚ö†Ô∏è Missing documentation for package: $pkg_name"
            fi
          fi
        done
        
        echo "‚úÖ Documentation validation completed"

    - name: Create documentation summary
      if: always()
      run: |
        echo "## üìö Documentation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Documentation Type**: $DOC_TYPE" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered By**: $EVENT_NAME" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "$DOC_TYPE" == "all" ] || [ "$DOC_TYPE" == "api" ]; then
          echo "‚úÖ **API documentation generated**" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "$DOC_TYPE" == "all" ] || [ "$DOC_TYPE" == "changelog" ]; then
          echo "‚úÖ **Changelog updated**" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "$DOC_TYPE" == "all" ] || [ "$DOC_TYPE" == "readme" ]; then
          echo "‚úÖ **README updated**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üìÑ **Documentation files updated**" >> $GITHUB_STEP_SUMMARY

    - name: Commit documentation changes
      if: github.event_name == 'push'
      run: |
        echo "üíæ Committing documentation changes..."
        
        # Check if there are changes to commit
        if [ -n "$(git status --porcelain)" ]; then
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          
          git add .
          git commit -m "üìö Update documentation
          
          - Generated API documentation
          - Updated changelog
          - Updated README
          - Automated by GitHub Actions"
          
          git push
          
          echo "‚úÖ Documentation changes committed"
        else
          echo "‚ÑπÔ∏è No documentation changes to commit"
        fi
