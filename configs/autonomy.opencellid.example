# OpenCellID GPS Configuration Example
# This file demonstrates how to configure OpenCellID cellular geolocation
# Copy relevant sections to your main /etc/config/autonomy file

# Main GPS configuration with OpenCellID enabled
config gps 'main'
	option enabled '1'
	option source_priority 'rutos,starlink,opencellid,google'
	option movement_threshold_m '100'
	option accuracy_threshold_m '100'
	option staleness_threshold_s '300'
	option collection_timeout_s '30'
	option retry_attempts '3'
	option retry_delay_s '2'
	option prefer_high_accuracy '1'
	option enable_movement_detection '1'
	option enable_location_clustering '1'
	
	# Hybrid confidence-based prioritization
	option enable_hybrid_prioritization '1'
	option min_acceptable_confidence '0.5'
	option fallback_confidence_threshold '0.7'
	
	# OpenCellID Configuration
	option opencellid_enabled '1'
	option opencellid_api_key 'your_opencellid_api_key_here'
	option opencellid_contribute '1'
	
	# Enhanced OpenCellID Settings
	option opencellid_cache_size_mb '25'
	option opencellid_max_cells_per_lookup '5'
	option opencellid_negative_cache_ttl_hours '12'
	option opencellid_contribution_interval '10'
	option opencellid_min_gps_accuracy '20.0'
	option opencellid_movement_threshold '250.0'
	option opencellid_rsrp_change_threshold '6.0'
	option opencellid_timing_advance_enabled '1'
	option opencellid_fusion_confidence '0.5'

# Ratio-based rate limiting (8:1 lookups:submissions over 48h)
option opencellid_ratio_limit '8.0'
option opencellid_ratio_window_hours '48'

# Automated scheduling (several times per hour when moving)
option opencellid_scheduler_enabled '1'
option opencellid_moving_interval '2'        # 2 minutes when moving (30 scans/hour)
option opencellid_stationary_interval '10'   # 10 minutes when stationary (6 scans/hour)
option opencellid_max_scans_per_hour '30'    # Rate limit

# Cell tower location configuration
config gps 'cell_tower'
	option cell_tower_enabled '1'
	option mozilla_enabled '1'
	option cell_tower_max_cells '6'
	option cell_tower_timeout '30'

# Example configuration for different scenarios

# Scenario 1: Conservative data usage (for metered connections)
# config gps 'conservative'
#	option opencellid_cache_size_mb '50'
#	option opencellid_contribution_interval '30'
#	option opencellid_min_gps_accuracy '10.0'
#	option opencellid_movement_threshold '500.0'

# Scenario 2: Aggressive contribution (for unlimited data)
# config gps 'aggressive'
#	option opencellid_contribution_interval '5'
#	option opencellid_min_gps_accuracy '30.0'
#	option opencellid_movement_threshold '100.0'
#	option opencellid_rsrp_change_threshold '3.0'

# Scenario 3: High accuracy requirements
# config gps 'high_accuracy'
#	option opencellid_fusion_confidence '0.8'
#	option opencellid_timing_advance_enabled '1'
#	option opencellid_max_cells_per_lookup '8'

# Notes:
# 1. Get your free OpenCellID API key from: https://opencellid.org/
# 2. Contributing data helps improve the database and maintains API access
# 3. Cache size should be adjusted based on available storage (25MB default)
# 4. Movement threshold determines when to submit new measurements (250m default)
# 5. RSRP change threshold detects significant signal changes (6dB default)
# 6. Timing advance improves accuracy for LTE networks when available
# 7. Negative cache TTL reduces API calls for unknown cells (12h default)
# 8. Contribution interval balances data usage vs. contribution frequency (10min default)

# Storage locations:
# - Cache database: /overlay/autonomy/opencellid_cache.db
# - Log files: /tmp/autonomy_opencellid.log (if file logging enabled)

# API Usage Guidelines:
# - Respect rate limits and quotas
# - Only submit high-quality GPS measurements (â‰¤20m accuracy)
# - Batch contributions to minimize API calls
# - Cache results to avoid repeated lookups
# - Contribute back to maintain good standing with OpenCellID

# Troubleshooting:
# - Check API key validity: ubus call autonomy gps_status
# - Monitor cache usage: ubus call autonomy gps_cache_stats  
# - View contribution stats: ubus call autonomy gps_contribution_stats
# - Enable debug logging: uci set autonomy.main.log_level=debug
