# =============================================================================
# ENHANCED WIFI OPTIMIZATION CONFIGURATION
# =============================================================================
# This configuration enables the enhanced WiFi optimization system that uses
# RUTOS built-in iwinfo scanning for sophisticated channel selection with
# RSSI-weighted interference scoring, overlap detection, and channel utilization.

# =============================================================================
# BASIC autonomy CONFIGURATION
# =============================================================================
config main 'settings'
    option enabled '1'
    option interval '30'
    option log_level 'info'
    option foreground '0'
    option ubus_timeout '10'

# =============================================================================
# ENHANCED WIFI OPTIMIZATION CONFIGURATION
# =============================================================================
config main 'wifi_optimization'
    # Core WiFi optimization settings
    option wifi_optimization_enabled '1'              # Enable WiFi optimization
    option wifi_movement_threshold '100.0'            # Movement threshold (meters)
    option wifi_stationary_time '1800'                # Stationary time (30 minutes)
    option wifi_optimization_cooldown '7200'          # Cooldown between optimizations (2 hours)
    
    # Nightly optimization (recommended for mobile deployments)
    option wifi_nightly_optimization '1'              # Enable nightly optimization
    option wifi_nightly_time '03:00'                  # Time for optimization (3 AM)
    option wifi_nightly_window '30'                   # Execution window (30 minutes)
    
    # Weekly optimization (optional for long-term stays)
    option wifi_weekly_optimization '0'               # Disable by default
    option wifi_weekly_days 'sunday,wednesday'        # Days for weekly optimization
    option wifi_weekly_time '02:00'                   # Time for weekly optimization
    option wifi_weekly_window '60'                    # Weekly execution window
    
    # Optimization parameters
    option wifi_min_improvement '15'                  # Minimum score improvement to apply changes
    option wifi_dwell_time '30'                       # Wait time after changes (seconds)
    option wifi_noise_default '-95'                   # Default noise floor (dBm)
    option wifi_vht80_threshold '80'                  # Score threshold for VHT80 (80MHz)
    option wifi_vht40_threshold '60'                  # Score threshold for VHT40 (40MHz)
    option wifi_use_dfs '1'                           # Allow DFS channels (radar detection)
    
    # GPS integration
    option wifi_gps_accuracy_threshold '50.0'         # Minimum GPS accuracy (meters)
    option wifi_location_logging '1'                  # Log GPS coordinates with optimizations
    
    # Scheduler settings
    option wifi_scheduler_check_interval '15'         # Minutes between schedule checks
    option wifi_skip_if_recent '1'                    # Skip if optimization happened recently
    option wifi_recent_threshold '6'                  # Hours threshold for "recent"
    option wifi_timezone 'UTC'                        # Timezone for scheduling

# =============================================================================
# ENHANCED SCANNING CONFIGURATION (NEW!)
# =============================================================================
config main 'enhanced_wifi'
    # Enable RUTOS-native enhanced scanning (uses ubus iwinfo)
    option wifi_use_enhanced_scanner '1'              # Enable enhanced scanning (recommended!)
    
    # RSSI interference weighting (dBm thresholds)
    option wifi_strong_rssi_threshold '-60'           # Strong interferer threshold (-60dBm = 30 penalty points)
    option wifi_weak_rssi_threshold '-80'             # Weak interferer threshold (-80dBm = 5 penalty points)
    
    # Channel utilization weighting
    option wifi_utilization_weight '100'              # Full weight for channel utilization penalty
    
    # Star rating thresholds (matches RUTOS GUI)
    option wifi_excellent_threshold '90'              # 5 stars threshold (90+ points)
    option wifi_good_threshold '75'                   # 4 stars threshold (75-89 points)
    option wifi_fair_threshold '50'                   # 3 stars threshold (50-74 points)
    option wifi_poor_threshold '25'                   # 2 stars threshold (25-49 points)
                                                       # 1 star = <25 points
    
    # Channel overlap penalty
    option wifi_overlap_penalty_ratio '0.5'           # Overlap penalty = 50% of co-channel penalty

# =============================================================================
# ENVIRONMENT-SPECIFIC CONFIGURATIONS
# =============================================================================

# For CAMPGROUNDS (dense WiFi environments):
# Uncomment these settings for campgrounds with many WiFi networks
#config main 'campground_settings'
#    option wifi_movement_threshold '50.0'            # More sensitive (50m)
#    option wifi_optimization_cooldown '3600'         # More frequent (1 hour)
#    option wifi_min_improvement '10'                 # Lower threshold for crowded environments
#    option wifi_weekly_optimization '1'              # Enable weekly for long stays
#    option wifi_strong_rssi_threshold '-65'          # More sensitive to strong interferers

# For HIGHWAY/TRAVEL (frequent movement):
# Uncomment these settings for frequent travel scenarios
#config main 'travel_settings'
#    option wifi_movement_threshold '150.0'           # Less sensitive (150m)
#    option wifi_optimization_cooldown '10800'        # Less frequent (3 hours)
#    option wifi_min_improvement '20'                 # Higher threshold
#    option wifi_weekly_optimization '0'              # Nightly only

# For REMOTE/RURAL areas (sparse WiFi):
# Uncomment these settings for remote areas with few networks
#config main 'rural_settings'
#    option wifi_movement_threshold '200.0'           # Even less sensitive (200m)
#    option wifi_optimization_cooldown '14400'        # Less frequent (4 hours)
#    option wifi_min_improvement '25'                 # Higher threshold
#    option wifi_nightly_optimization '0'             # Weekly only
#    option wifi_weekly_optimization '1'

# =============================================================================
# MONITORING AND DEBUGGING
# =============================================================================
config main 'monitoring'
    option log_level 'info'                          # info/debug for detailed WiFi logs
    # Set to 'debug' for detailed channel analysis logging:
    # option log_level 'debug'

# =============================================================================
# BASIC MEMBER CONFIGURATION
# =============================================================================
# You still need to configure your network members (Starlink, cellular, etc.)
# This example focuses on the enhanced WiFi optimization features.

config member 'starlink'
    option enabled '1'
    option interface 'wwan0'
    option class 'starlink'
    option priority '1'
    option weight '100'

config member 'cellular'
    option enabled '1'
    option interface 'wwan1'
    option class 'cellular'
    option priority '2'
    option weight '80'

# =============================================================================
# USAGE EXAMPLES
# =============================================================================

# Enable enhanced WiFi optimization:
# uci set autonomy.wifi_optimization.wifi_optimization_enabled='1'
# uci set autonomy.enhanced_wifi.wifi_use_enhanced_scanner='1'
# uci commit autonomy
# /etc/init.d/autonomy restart

# Check WiFi optimization status:
# ubus call autonomy status | grep -A10 wifi
# logread | grep -i wifi | tail -10

# Monitor channel analysis (if monitoring API is enabled):
# ubus call autonomy wifi_channel_analysis

# =============================================================================
# EXPECTED BEHAVIOR
# =============================================================================

# With enhanced scanning enabled, you should see logs like:
# 
# {
#   "ts": "2025-01-15T14:30:15Z",
#   "level": "info", 
#   "msg": "Using enhanced RUTOS-native scanning",
#   "trigger": "movement_detected"
# }
#
# {
#   "ts": "2025-01-15T14:30:52Z",
#   "level": "info",
#   "msg": "Enhanced optimal channel plan determined",
#   "method": "rutos_native_enhanced",
#   "channel_24": 1,
#   "score_24": 92,
#   "stars_24": 5,
#   "aps_24": 2,
#   "strong_interferers_24": 0,
#   "utilization_24": 0.15,
#   "recommendation_24": "Excellent choice - minimal interference",
#   "channel_5": 149,
#   "score_5": 78,
#   "stars_5": 4,
#   "aps_5": 3,
#   "strong_interferers_5": 1,
#   "utilization_5": 0.25,
#   "recommendation_5": "Good choice - acceptable interference levels",
#   "width_5": "VHT40",
#   "total_score": 170
# }

# =============================================================================
# PERFORMANCE BENEFITS
# =============================================================================

# Enhanced scanning provides:
# 1. RSSI-weighted interference scoring (strong interferers penalized more)
# 2. Channel overlap detection (2.4GHz and 5GHz)
# 3. Real channel utilization data from WiFi drivers
# 4. 5-star rating system matching RUTOS GUI
# 5. Intelligent bandwidth selection (20/40/80 MHz)
# 6. Native RUTOS integration using ubus iwinfo

# Expected improvements:
# - Better channel selection in dense WiFi environments (campgrounds)
# - Smarter bandwidth selection based on interference levels
# - More accurate interference assessment
# - Consistent results with RUTOS built-in WiFi analyzer
